name: Maven Release

on:
  pull_request:
    types: [ closed ]
    paths:
      - '.github/project.yml'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    name: release

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false # otherwise, the token used is the PA_TOKEN, instead of your personal access token.
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.

      - uses: radcortez/project-metadata-action@203f7ffba8db2669b2c9b4d4c2e90b186c588fa5 # 1.1
        name: Retrieve project metadata from '.github/project.yml'
        id: metadata
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          metadata-file-path: '.github/project.yml'
          local-file: true

      - name: Configure Git author
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Cuioss Robot Action"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version.cui.parent and reproducible.build.outputTimestamp in root pom.xml
        run: |
          export CURRENT_VERSION="${{ steps.metadata.outputs.current-version }}"
          export OUTPUT_TIMESTAMP="$(date -u +'%Y-%m-%dT00:00:00Z')"
          echo "Updating version.cui.parent to: $CURRENT_VERSION"
          echo "Updating reproducible.build.outputTimestamp to: $OUTPUT_TIMESTAMP"
          ./mvnw -q versions:set-property -Dproperty=version.cui.parent -DnewVersion="$CURRENT_VERSION" -DgenerateBackupPoms=false
          ./mvnw -q versions:set-property -Dproperty=reproducible.build.outputTimestamp -DnewVersion="$OUTPUT_TIMESTAMP" -DgenerateBackupPoms=false

      - name: Commit and push property updates
        run: |
          git add pom.xml
          if ! git diff --cached --quiet; then
            git commit -m "chore: update version.cui.parent and reproducible.build.outputTimestamp for release"
            git pull --rebase origin ${{ github.ref_name }}
            git push origin ${{ github.ref_name }}
          else
            echo "No changes to commit."
          fi

      - name: Maven release ${{steps.metadata.outputs.current-version}}
        run: |
          ./mvnw -Prelease-pom -B release:clean release:prepare -DreleaseVersion=${{steps.metadata.outputs.current-version}} -DdevelopmentVersion=${{steps.metadata.outputs.next-version}}
          ./mvnw -Prelease-pom site:site site:stage
          ./mvnw -Prelease-pom -B release:perform -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.OSS_SONATYPE_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.OSS_SONATYPE_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Deploy Maven Site to cuioss.github.io -> ${{steps.metadata.outputs.pages-reference}}ðŸš€
        uses: JamesIves/github-pages-deploy-action@6c2d9db40f9296374acc17b90404b6e8864128c8 # v4.7.3
        with:
          folder: target/staging
          repository-name: cuioss/cuioss.github.io
          target-folder: ${{steps.metadata.outputs.pages-reference}}
          branch: main
          token: ${{ secrets.PAGES_DEPLOY_TOKEN }}

      - name: Push release branch and tags
        run: |
          git pull --rebase origin ${{ github.ref_name }}
          git fetch --tags
          git push origin ${{ github.ref_name }}
          git push --tags